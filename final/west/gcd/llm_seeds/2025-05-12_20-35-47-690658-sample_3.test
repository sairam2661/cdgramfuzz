set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex

proc complex_func {argc argv} {
  if {$argc eq 3} {
    proc new_test {name {test {}}} {
      do_test $name {
        db eval {
          CREATE TABLE tb1(x);
          INSERT INTO tb1 VALUES(1);
          INSERT INTO tb1 VALUES(2);
        }
        db eval $test
      } $test
    }
  }
}

do_test complex-1.1 {
  set rc
  sqlite3rcache_set_size 16
  set rc
  sqlite3rcache_query_usage 1
  execsql {
    CREATE TABLE a(x);
    INSERT INTO a VALUES(1);
    INSERT INTO a VALUES(2);
  }
  execsql {SELECT count(*) FROM a}
} {2}

do_execsql_test complex-1.2 {
  BEGIN;
  INSERT INTO a VALUES(3);
  COMMIT;
  SELECT count(*) FROM a;
} {3}

do_test complex-1.3 {
  DB SQL Trace
  do_test complex_trace {
    catchsql {SELECT 1 FROM a}
  } {0 {1}}
} {0 {1}}

ifcapable rtree {
  db eval {
    CREATE TABLE rtree(x, y);
    INSERT INTO rtree VALUES(1, 1);
  }
}

finish_test