set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix largequery

proc large_query {} {
  global largeargs
  set largeargs $largeargs" large_query"
  set largeargs $largeargs
  expr {

    sqlite3 large_connection large_database ":memory:"

    large_connection eval {
      CREATE TABLE t1(a, b, c);
      INSERT INTO t1 VALUES(1, 2, 3);
    }

    large_query large_connection "SELECT * FROM t1 JOIN t1 ON t1.a = t1.a"

    large_connection close
    expr {1}
  }
}

proc large_query {db query} {
  for {set N 100} {$N} {incr N} {
    db eval {
      CREATE TABLE t$N AS SELECT NULL
    }
  }

  db eval {
    CREATE INDEX i ON sqlite_master(id)
  }

  do_execsql_test largequery$N {
    EXPLAIN QUERY PLAN $query
  } {

    0 0 0   0   0   0   0   0   0   1   
    1 0 0   0   0   0   0   0   1   1   
    0 0 0   0   0   0   0   0   0   1   
  
  }

  db eval {PRAGMA vdbe_listing = 1}
  do_execsql_test largequery$N $query

  db eval {PRAGMA vdbe_listing = 0}

  catch {db eval "DROP TABLE sqlite_template"}
  catch {db eval "SELECT * FROM t10"}
  catch {db eval "DELETE FROM t2 WHERE $query"}
  catch {db eval "UPDATE t2 SET $query"}
}

do_test largequery-1.1 {
  set largeargs ""
  list $largeargs
} {}

do_test largequery-1.2 {
  execsql {
    CREATE TABLE t1(a, b, c);
    INSERT INTO t1 VALUES(1, 2, 3);
  }
} {}

ifcapable!= {VDBE_LISTING} {
  finish_test
  return
}

do_test largequery-1.3 {
  set testvars {}
  foreach {var value} {
    large_query                        large_query
    largeargs                            {}
  } {
    lappend testvars   $var $value
    set $var $value
  }
  lsort $testvars
  set testvars
} {large_query largeargs}

do_test largequery-1.4 {
  proc proc args {return 0}
  proc proc {args} {return 0}
  proc args {return 0}
  proc args {return 0}
  list args args
} {}

do_test largequery-1.5 {
  proc proc {args} {return 0}

  proc args {args} {
    set args
    uplevel 1 args $args
  }
  ifuplevel {} {foo} {args {}}
  list foo args
} {}
proc large_connection {args} {set large_connection $large_connection $args}
catch {proc large_connection}
proc large_connection {
  return 0
}

finish_test