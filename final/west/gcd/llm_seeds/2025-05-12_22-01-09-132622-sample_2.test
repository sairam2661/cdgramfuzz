set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex_query

proc complex_query_func {} {
  set query {
    SELECT 1 AS col1
       FROM sqlite_master 
       WHERE type IN 
          SELECT type 
             FROM sqlite_master 
    }
  set db_handle
  set stmt_handle
  set ret_int
  set ret_str
  db_connection $db_handle
  prepare_statement $stmt_handle $db_handle $query
  bind_parameter $stmt_handle 1 NULL
  execute_statement $stmt_handle
  column_count $stmt_handle $ret_int
  bind_result $stmt_handle $ret_str
  while {fetch_row $stmt_handle} {result $ret_str}
  return $ret_int
}

do_test complex-1.1 {
  execsql {
    CREATE TABLE complex_query_a(x);
  }
  execsql {
    INSERT INTO complex_query_a VALUES(1);
    INSERT INTO complex_query_a VALUES(2);
  }
  execsql {
    BEGIN;
    INSERT INTO complex_query_a VALUES(3);
  }
  execsql {SELECT 1}
} {1}

do_execsql_test complex-1.2 {
  COMMIT;
  BEGIN;
  INSERT INTO complex_query_a VALUES(4);
  SELECT * FROM complex_query_a;
} {4 1 2 3 4}

finish_test