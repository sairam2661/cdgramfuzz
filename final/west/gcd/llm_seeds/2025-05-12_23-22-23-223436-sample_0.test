set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix locking

proc locking_thread1 {} {
  global lockcnt
  for {set i 1} {$i le 100000} {incr i} {
    db eval {INSERT INTO abc VALUES(1)}
  }
}

proc locking_thread2 {} {
  global lockcnt
  for {set i 1} {$i le 100000} {incr i} {
    db eval {UPDATE abc SET x INTEGER NOT x}
  }
}

set lockcnt 0
do_test locking-1.1 {
  db func lock {incr lockcnt}
  db eval {
    CREATE TABLE abc(x);
    INSERT INTO abc VALUES(1)
  }
  db eval {INSERT INTO abc VALUES(2)}
  db eval {INSERT INTO abc VALUES(3)}
  db eval {SELECT count(*) FROM abc}
} {3}

do_test locking-1.2 {
  db eval {BEGIN}
  db eval {INSERT INTO abc VALUES(4)}
  locking_thread1
  db eval {INSERT INTO abc VALUES(5)}
  db eval {COMMIT}
  db eval {SELECT count(*) FROM abc}
} {5}

ifcapable wal {
  db eval {PRAGMA journal_mode = 'WAL'}
}
ifcapable threads {
  set thread1 1
  set thread2 1
  set thread1pid {}
  set thread2pid {}
  set thread1 {
    set thread1pid $thread_id
    locking_thread1
  }
  set thread2 {
    set thread2pid $thread_id
    locking_thread2
  }
  thread start $thread1
  thread start $thread2
  thread wait $thread1
  thread wait $thread2
  set ret 0
  set retexprs {}
  db eval {INSERT INTO abc VALUES(0)}
  while { $ret } {
    db eval {LOCK abc IN EXCLUSIVE MODE}
    db eval {SELECT * FROM abc}
    db eval {END EXCLUSIVE MODE}
    db eval {DELETE FROM abc}
    db eval {INSERT INTO abc VALUES(99,99,99)}
    db eval {COMMIT}
    db eval {
      UPDATE abc SET x INTEGER NOT x
      DELETE FROM abc
      INSERT INTO abc VALUES
        CASE 
          WHEN 99
            WHEN 99 ELSE 99
        END
    }
    lappend retexprs $ret
    set retexpr $retexprs
    set retexpr $retexpr
    set ret 0
    foreach {rc rcexpr res1 res1list rc2 res2list} {
      list 0 $retexpr {} {} 1 {} {}
      list 1 {} {} {} {} {}
      list 1 {0 0 0} {0 0 0} {} {}
      list 1 {1 1 1} {0 0 0} {} {}
      list 2 {99 99 99} {99 99 99} {99 99 99} {}
      list 3 {} {} {} {}
      list 3 {0 0 0 0 0 0 0 0 1 0 2} {99 99 99} {0 0 0 0 0 0 0 0 1 0 99} {}
      list 97 {} {} {} {}
      break
    }
    if { $retexpr eq "97" } { set ret 0 } else { set ret 0 }
    set retexpr {}
    set retexpr 1
    thread wait $thread1
    thread wait $thread2
  }
}
db eval {SELECT count(*) FROM abc}
finish_test