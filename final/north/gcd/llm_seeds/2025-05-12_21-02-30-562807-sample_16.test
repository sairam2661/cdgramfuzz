set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix fuzz

proc setup {} {
  global db
  sqlite3 db testdb
  execsql {
    PRAGMA journal_mode = 'WAL';
    CREATE TABLE t1(a, b, PRIMARY_KEY UNIQUE, c);
    CREATE TABLE t2(d, e, PRIMARY_KEY UNIQUE, f);
  }
}

proc tear_down {} {
  close db
}

proc test_query {query} {
  ifcapable fulltext {
    execsql {
      BEGIN;
      CREATE TABLE t3(g, h, TEXT);
      INSERT INTO t3 VALUES(1, 'one');
      INSERT INTO t3 VALUES(2, 'two');
      COMMIT;
    }
  }
  execsql $query
}

proc test_query2 {query} {
  set STMT "
    INSERT INTO t1 VALUES('a', 'b', $STMT, 'e')
  "
  set STMT2 "
    INSERT INTO t2 VALUES('d', 'e', $STMT2, 'f')
  "
  execsql "
    $STMT;
    $STMT2;
    PRAGMA page_size = 8192
  "
}

do_test fuzz-1.1 {
  setup
  test_query "CREATE VIEW v1 AS SELECT * FROM t1"
} {}

do_test fuzz-1.2 {
  setup
  test_query2 "CREATE INDEX i1 ON t1(a,b)"
} {}

do_execsql_test fuzz-1.3 {
  BEGIN;
  INSERT INTO t1 VALUES(1, 2, 3, 4);
  INSERT INTO t1 VALUES(4, 3, 2, 1);
  COMMIT;
  SELECT count(*) FROM t1 WHERE a = 2;
} {1}

ifcapable fulltext {
  do_execsql_test fuzz-1.4 {
    INSERT INTO t3 VALUES(1, 'one two');
    SELECT MATCHIVITY FROM t3 WHERE g = 1
  } {1}
}
do_execsql_test fuzz-1.5 {
  INSERT INTO t1 VALUES(1, 'one two', 2, 4);
  SELECT a FROM t1 WHERE b = 'one two'
} {1}

tear_down
finish_test