set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex_test

set ::timeout 60000
set sqlite_extension 0
set temp_store 2

proc setup {} {
  global sqlite_extension temp_store
  ifcapable WAL {
    catchsql "PRAGMA journal_mode=WAL"
  } else {
    catchsql "PRAGMA journal_mode=DELETE"
  }
  sqlite_dbconfig temp_store 2
  do_execsql_test complex_test1.1 {
    CREATE TABLE a(x);
    INSERT INTO a VALUES(1);
  }
}

proc cleanup {} {
  set temp_store 0
}

do_execsql_test complex_test2.1 {
  SELECT name FROM sqlite_master
} {a}

do_test complex_test3.1 {
  execsql {
    CREATE TABLE b(y);
    INSERT INTO b(y) VALUES(6);
  }
  llength {
    SELECT x FROM a UNION ALL SELECT y FROM b
  }
} {2}

do_execsql_test complex_test4.1 {
  BEGIN TRANSACTION
  INSERT INTO b VALUES 7
  COMMIT
  SELECT count FROM b
} {2}

ifcapable wal_journal {
  set sqlite_dbconfig temp_store 0
}

do_test complex_test5.1 {
  sqlite_dbconfig temp_store 0
  execsql {
    SELECT * FROM a
  } 
  execsql {
    UPDATE a SET x WHERE x SET 10
  }
  llength {
    SELECT x FROM a
  }
} {1}

do_execsql_test complex_test6.1 {
  SELECT * FROM a
} {10}

cleanup
finish_test