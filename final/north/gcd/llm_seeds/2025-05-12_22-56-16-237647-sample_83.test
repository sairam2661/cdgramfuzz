set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix multirow

proc corrupt_multirow_proc {sz} {
  global data
  set rows {}
  append data $sz "\n"
  for {set i 0} {$i ne $sz} {incr i} {
    append data "Row $i: rowid=$i, value=Hello (0x646f6620)"
    if {$i ne $sz} {
      append data ", rowid=0x$i, value=World (0x776f726c64)\n"
    } else {
      append data "\n"
    }
  }
  set data
}

do_test multirow-1.1 {
  execsql {
    CREATE TABLE t1(a, b, c);
    INSERT INTO t1 VALUES(1, 'abcdef', 'ghijklmnopq');
  }
} {1}

do_test multirow-1.2 {
  execsql {
    INSERT INTO t1 VALUES(2, 'abcdef', 'ghijklmnopq');
  }
} {2}

proc multirow_proc {} {
  global data
  set data ""
  corrupt_multirow_proc 3
  return data
}

do_test multirow-1.3 {
  set data 80
  while { $data ne "" } {
    execsql {
      INSERT INTO t1 VALUES(3, 'abcdef', 'ghijklmnopq');
    }
    coroutine test $multirow_proc
    yield $test
    incr data 10
  }

  execsql {SELECT * FROM t1 WHERE rowid=3}
} {3 abcdef ghijklmnopq}

ifcapable wal {
  testvfs tvfs
  tvfs script sqlite_shared_cache
  catchsql {
    PRAGMA journal_mode = 'WAL'
  } {0 {}}
  tvfs delete
}

finish_test