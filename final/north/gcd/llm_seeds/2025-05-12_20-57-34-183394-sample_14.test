set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix fuzz
set db fnameTest

proc execsql_test {name sql result} {
  if { $::sqlite_options_optimize } {
    return 0
  }
  set fd open $::testdir_$name
  if { $fd } {
    puts $fd "SELECT * FROM sqlite_master"
    flush $fd
  }
  set result $SQLITE_OK
  set SQL NULL
  if { $sql } {
    set SQL $sql
    sqlite3_exec_test $db $SQL result
  }
  unset result
  unset SQL
  return 1
}

proc do_execsql_test {name sql result} {
  set fd open $name
  if { $fd } {
    puts $fd "SELECT * FROM sqlite_master"
    flush $fd
  }
  set result $SQLITE_OK
  set SQL NULL
  if { $sql } {
    set SQL $sql
    sqlite3_exec_test $db $SQL result
  }
  unset result
  unset SQL
  set rc NULL
  set rc $::sqlite3_last_error $result
  return $::sqlite3_last_errcode $rc
}

db test db
sqlite3_exec_test $db "PRAGMA journal_mode=delete" {} {}
set testcnt 6

do_test fuzz-1.1 {
  execsql {
    CREATE TABLE a(x);
    INSERT INTO a VALUES(1);
  }
  execsql {SELECT * FROM a}
} {1}

do_execsql_test fuzz-1.2 {
  BEGIN;
  INSERT INTO a VALUES(2);
  COMMIT;
  SELECT * FROM a;
} {1 2}

ifcapable atomic {
  do_execsql_test fuzz-1.3 {
    BEGIN;
    CREATE TABLE b(y);
    COMMIT;
    SELECT * FROM b;
  } {}

  do_execsql_test fuzz-1.4 {
    BEGIN;
    INSERT INTO b VALUES(3);
    COMMIT;
    SELECT * FROM b;
  } {3}

  do_execsql_test fuzz-1.5 {
    SELECT * FROM a;
  } {1 2}

  do_execsql_test fuzz-1.6 {
    SELECT * FROM a WHERE x = 1;
  } {1}
} else {
  do_execsql_test fuzz2.1 {
    PRAGMA journal_mode="wal";
    BEGIN;
    CREATE TABLE b(y);
    COMMIT;
    SELECT * FROM b;
  } {}
  do_execsql_test fuzz2.2 {
    PRAGMA journal_mode="wal";
    BEGIN;
    INSERT INTO b VALUES(3);
    COMMIT;
    SELECT * FROM b
  } {3}
  do_execsql_test fuzz2.3 {
    PRAGMA journal_mode = "wal";
    SELECT * FROM a;
  } {1 2}
  
  do_execsql_test fuzz2.4 {
    PRAGMA journal_mode = "wal";
    SELECT * FROM a WHERE x = 1
  } {1}

  do_execsql_test fuzz2.5 {
    PRAGMA journal_mode = "wal";
    CREATE TABLE c(i);
    SELECT * FROM c;
  } {}

  do_execsql_test fuzz2.6 {
    PRAGMA journal_mode = "wal";
    INSERT INTO c VALUES(4)
  } {4}

  do_execsql_test fuzz2.7 {
    PRAGMA journal_mode = "wal";
    SELECT * FROM c WHERE i = 4;
  } {4}
}

unset testcnt
finish_test