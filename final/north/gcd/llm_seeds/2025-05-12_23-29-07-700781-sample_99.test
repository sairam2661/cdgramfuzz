set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix fuzz_query

proc create_table {name} {
  global db
  execsql "CREATE TABLE $name (a text, b integer, c real)"
}

proc drop_table {name} {
  global db
  execsql "DROP TABLE $name"
}

proc select_query {name} {
  global db
  execsql "SELECT * FROM $name ORDER BY a"
}

proc select_query_count {name} {
  global db
  execsql "SELECT count(*) FROM $name"
}

proc insert_data {name} {
  global db
  execsql "INSERT INTO $name VALUES ('value', 10, 20.5)"
}

proc set_journal_mode {mode} {
  global db
  execsql "PRAGMA journal_mode = $mode"
}

proc set_wal_checkpoint {mode} {
  global db
  execsql "PRAGMA wal_checkpoint = $mode"
}

proc exec_query {sql} {
  global db
  execsql $sql
}

do_test fuzz-1.1 {
  set db main
  setjournal_mode OFF
  set_wal_checkpoint SYNC
  exec_query {
    CREATE TABLE a(x);
    INSERT INTO a VALUES(1);
    INSERT INTO a VALUES(2);
    INSERT INTO a VALUES(3);
  }
} {}

do_test fuzz-1.2 {
  create_table b
  insert_data b
  select_query b
} {value 10 20.5}

do_execsql_test fuzz-1.3 {
  CREATE TABLE c(a);
  INSERT INTO c VALUES('value1');
  INSERT INTO c VALUES('value2');
  CREATE INDEX idx_c ON c(a);
  SELECT a FROM c WHERE a = 'value1';
} {value1}

do_execsql_test fuzz-1.4 {
  BEGIN;
  INSERT INTO c VALUES('value3');
  COMMIT;
  SELECT count(*) FROM c;
} {3}

setjournal_mode WAL

finish_test