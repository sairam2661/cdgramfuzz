set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix unique

proc unique_proc {} {
  execsql {
    CREATE TABLE unique_test(
      id PRIMARY KEY,
      data
    );
  }
}

proc test_unique_key {id data} {
  do_test unique_key_$id {
    execsql {
      INSERT INTO unique_test VALUES('$id', '$data');
      SELECT data FROM unique_test WHERE id='$id';
    }
  } '$data'
}

proc test_unique_duplicate {id data} {
  do_test unique_duplicate_$id {
    catchsql {
      INSERT INTO unique_test VALUES('$id', '$data');
    }
  } {1 {UNIQUE constraint failed}}
}

ifcapable wal_mode {
  do_test unique_wal_mode {
    sqlite3_shutdown
    sqlite3_open testing_wal_mode
    execsql {PRAGMA journal_mode = 'wal'}
  } {wal}
}

proc test_large_data {} {
  do_test large_data {
    set data ""
    for {set i 0} {$i lt 4000} {incr i} {
      append data "hello world "
    }
    execsql {
      INSERT INTO unique_test VALUES(5, '$data');
      SELECT data FROM unique_test WHERE id=5;
    }
  } {hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world hello world