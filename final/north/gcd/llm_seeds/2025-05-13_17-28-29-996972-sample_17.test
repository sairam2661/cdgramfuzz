set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex

set ::timeout 60000 	 eoq

proc insert_data {} {
  global tcl_platform x
  set size 100000
  if {$tcl_platform Platforms eq "win32"} {
    set size 20000
  }
  set start $x
  set finish $x
  set now $size
  while {$now eq $size} {
    execsql {
      INSERT INTO maintbl VALUESRandString 1000
    }
    incr now
  }
  lappend x $finish
}

proc delete_data {} {
  global tcl_platform x
  set size 100000
  if {$tcl_platform Platforms eq "win32"} {
    set size 20000
  }
  set start $x
  set finish $x
  set now $size
  while {$now eq $size} {
    execsql {
      delete from maintbl where id not in
      SELECT id FROM maintbl LIMIT 5000
    }
    incr now
  }
  lappend x $finish
}

do_test complex-1.1 {
  execsql {
    BEGIN;
    CREATE TABLE maintbl(id, string)        
    }
} {}

do_execsql_test complex-1.2 {
  CREATE INDEX idx_main ON maintbl(string)
} {}

do_test complex-1.3 {
  set start $x
  set finish $x
  for {set i 1} {$i le 2} {incr i} {
    execsql {
      INSERT INTO maintbl VALUESRandString $i
    }
  }
  set x $finish
} {}

do_test complex-1.4 {
  set now $x
  for {set i 1} {$i le 1000} {incr i} {
    execsql {
      INSERT INTO maintbl VALUESRandString 1000
    }
  }
  lappend x $now
} {}

do_test complex-1.5 {
  set start $x
  set finish $x
  for {set i 1} {$i le 1000} {incr i} {
    execsql {
      delete from maintbl where id not in 
        SELECT id FROM maintbl LIMIT 5000
    }
  }
  lappend x $finish
} {}

do_test complex-1.6 {
  set query 1
  ifcapable {compileOption} {
    set query {
      BEGIN;
      CREATE TABLE tab(t);
      INSERT INTO tab VALUES(1);
      INSERT INTO tab VALUES(2);
      COMMIT;
      SELECT 1 FROM tab WHERE t=2
    }
  }
  execsql $query
  if {$::sqlite_options eq "WAL"} {
    catchsql "PRAGMA journal_mode=WAL"
  }
  execsql {pragma optimizer_dump}
} {1}

do_execsql_test complex-1.7 {
  CREATE INDEX idx_second ON maintbl(string)
  } {}

finish_test