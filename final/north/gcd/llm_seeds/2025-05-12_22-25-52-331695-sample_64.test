set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix sync2
test_sql_preload 1

proc create_table {} {
  global DB
  execsql {CREATE TABLE a(x);}
}

proc insert_values {} {
  global DB
  foreach {i} {4 5 6} {
    execsql {INSERT INTO a VALUES(1);}
  }
}

proc select_values {} {
  global DB
  execsql {SELECT count(*) FROM a;}
}

proc test_sync_data {} {
  catch {db close}
  if {sqlite3 $DB test sync_mode none} {
    set syncargs {}
    do_test sync2_1.1 {
      insert_values
      select_values
    } {3}
    do_test sync2_1.2 {
      catchsql {BEGIN; INSERT INTO a VALUES(4); COMMIT;}
      select_values
    } {4}
    ifcapable journalMode {
      set wal_on 1
      set wal_off 0
      catchsql {PRAGMA journal_mode=1}
    }
    finish_test
  } else {
    do_test sync2_1.1 {
      execsql {
        CREATE TABLE b(x);
        INSERT INTO b VALUES(5);
      }
      execsql {SELECT count(*) FROM b;}
    } {1}
    test_sync_data_error
  }
}

proc test_sync_data_error {} {
  do_test sync2_1.3 {
    set WAL {wal}
    set WAL_OK {1}
    set NO_WAL {none}
    set {wal_no_wal_ok} {none}
    test_sql {
      CREATE TABLE c(x);
    } sync2_1.3
    catch {execsql BEGIN}
    set {journal_mode} {wal}
    execsql {PRAGMA journal_mode = 1}
    catch {execsql COMMIT}
    set {db_flags} {1}
    test_sql {PRAGMA journal_mode = 'WAL'}{sync2_1.3}
    set {db_flags} {0}
    execsql {BEGIN}
    test_sql {PRAGMA journal_mode = 0}{sync2_1.3}
    set {db_flags} {0}
    execsql {COMMIT}
    test_sql {
      CREATE TABLE d(x);
      PRAGMA synchronous = 2
      }
    {wal}
  } {wal}
  finish_test
}

test_sync_data

finish_test