set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex_tests

set ::timeout 60000
set db {} 
set ncr 0 

proc create_table {} {
  global db
  set db {} 
  execsql {
    CREATE TABLE a(x);
    INSERT INTO a VALUES(1,2,3);
    INSERT INTO a VALUES(4,5,6);
  }
}

proc test_data {name value} {
  global ncr
  incr ncr
  set ncr_name "$name-$ncr"
  set sql {
    UPDATE a 
    SET name 	$nncr_name
    WHERE  x 	$value
  }
}

do_test complex-1.1 {
  create_table
  execsql {SELECT * FROM a}
} {1 2 3 4 5 6}

do_execsql_test complex-1.2 {
  BEGIN;
  INSERT INTO a VALUES(7,8,9);
  COMMIT;
  SELECT * FROM a;
} {1 2 3 4 5 6 7 8 9}

lappend env SQLITE_DEBUG 1
do_test complex-1.3 {
  set sql {
    UPDATE a 
    SET x 	10
    WHERE  x 	1
  }
  uplevel $sql
  db eval $sql
  execsql {SELECT ROWID FROM a WHERE x = 1} 
  execsql {SELECT x FROM a WHERE x = 1}
} {1}

proc test_data2 {name value} {
  global ncr
  incr ncr
  set ncr_name "$name-$ncr"
  set sql {
    UPDATE a 
    SET name 	$ncr_name
    WHERE  x 	$value
  }
}

do_test complex-1.4 {
  test_data2 name 10
  set sql {
    UPDATE a 
    SET name 	'' 
    WHERE  name 	'complex-1.4-1'
  }
  uplevel $sql
  db eval $sql
  execsql {SELECT ROWID FROM a}
} {1 2 3 4 5 6 7 8 9}

finish_test