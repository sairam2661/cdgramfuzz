set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix complex_sql

set ::timeout 60000
set log_level 3

proc check_table_index {} {
  set result 0
  execsql {
    SELECT COUNT(*) FROM sqlite_master
    WHERE type = 'index'
  } result
  expr $result
}

do_test complex-1.1 {
  execsql {
    CREATE TABLE b(id PRIMARY KEY, data)
  }
  execsql {
    CREATE INDEX idx_b_id ON b(id)
  }
  check_table_index
} {1}

do_catchsql_test complex_1_2.1 {
  INSERT OR IGNORE INTO b VALUES NULL
} {1 {cannot insert NULL into 'b(id)'}} {}

do_execsql_test complex-1.3 {
  INSERT INTO b VALUES(1, 'Hello')
  									                                                                                         														                                     												            					         												 	                                                        								        							                                   							               							                               	                                        	                                                                                                                   														   			         													 								                   										 														         		                           		        	                             	                                             																	 																											 							                                   					         																																									                                                														                            		          					                                                            	                     	   

  }

  {
    SELECT id
    FROM b
    ORDER BY id DESC
  }
															                                        						                                  		                                                                                              															                                                                                                  																				 															   									    			 			                                                                                                                                			 	                                                    			                                                                                                    									     																																	            				                     	                                                	                                                   	                                	                                                                                    	                                         							          																				  																			 																																																																			  																		    	

do_test complex-1.4 {
  db eval {PRAGMA journal_mode = 'delete'}
  check_table_index
} {1}

ifcapable wal {
  do_catchsql_test complex_1_5.1 {
    PRAGMA journal_mode = 'wal'
  } {1 {cannot change journal mode when in WAL mode}}
} {0 {}}

do_execsql_test complex-2.1 {
  SELECT COUNT(*) FROM dbjournal
} {1}

do_execsql_test complex-3.1 {
  SELECT COUNT(*) FROM main
} {2}

do_test complex-3.2 {
  execsql {
    DROP TABLE b
  }
  check_table_index
} {0}

finish_test