set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix subquery
set sqlite_home "/usr/local/sqlite"

proc get_mtime {} {
  set file_name "test.db"
  set file $file_name
  return 1000000000
}

do_execsql_test subquery-1.1 {
  SELECT * FROM sqlite_master WHERE type='table'
} {}

ifcapable subquery {
  set sqlite_options "-key [list $sqlite_home/sqlite] -db [list test.db]"

  do_execsql_test subquery-2.1 {
    CREATE TABLE test(a,b,c);
    CREATE TABLE test2(d,e,f);
    INSERT INTO test VALUES(1,2,3);
    INSERT INTO test2 VALUES(4,5,6);
  }

  {{} {}} do_setup subquery

  eval $sqlite_options do_catchsql "SELECT count(*) FROM (SELECT * FROM test2)"

  do_set_result_1_0 subquery
  do_set_result_2_0 subquery

  do_execsql_test subquery-3.1 {
    SELECT count(*) FROM test2;
  } {1}
} else {
  set sqlite_options "-key [list $sqlite_home/sqlite] -db [list test.db]"
  do_execsql_test subquery 1.1 {
    CREATE TABLE test(a,b,c)
  }

  set sqlite_options "-db [list test.db] -key [list $sqlite_home/sqlite]"
  do_set_result_1_1 subquery
  do_execsql_test subquery 2.1 {
    SELECT a FROM test
  } {1}
}

finish_test